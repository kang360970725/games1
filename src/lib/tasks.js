"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),runTask=function(){var _ref=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee(task,context){var result;return _regenerator2["default"].wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:result=void 0,_context.t0=task.type,_context.next=_context.t0===_types.AIRDROP?4:8;break;case 4:return _context.next=6,airdrop(task,context);case 6:return result=_context.sent,_context.abrupt("break",9);case 8:result={state:STATE.ERROR,error:errors.UNKNOWN_TASK_TYPE};case 9:return _context.abrupt("return",result);case 10:case"end":return _context.stop()}},_callee,this)}));return function(_x,_x2){return _ref.apply(this,arguments)}}(),airdrop=function(){var _ref2=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function _callee2(task,context){var data,token,addresses,amount,nonce,sender,gasPrice,secret,web3,network;return _regenerator2["default"].wrap(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(data=task.data,token=data.token,addresses=data.addresses,amount=new web3.BigNumber(data.amount),nonce=task.nonce,sender=task.address,gasPrice=task.gasPrice,secret=context.secret,web3=context.web3,network=context.network,web3.isAddress(token)){_context2.next=12;break}return _context2.abrupt("return",{state:STATE.ERROR,error:errors.INVALID_ADDRESS});case 12:if(0!==addresses.length){_context2.next=14;break}return _context2.abrupt("return",{state:STATE.ERROR,error:errors.MISS_PARAMETER});case 14:if(!amount.lte(0)){_context2.next=16;break}return _context2.abrupt("return",{state:STATE.ERROR,error:errors.MISS_PARAMETER});case 16:return _context2.abrupt("return",erc20.erc20At(token,web3).then(function(_tokenC){return erc20.erc20Stat(_tokenC,sender)}).then(function(_tokenStat){var total=amount.mul(addresses.length);if(total.gt(_tokenStat.balance))return _promise2["default"].reject(errors.TOKEN_NOT_ENOUGH);var airdropC=web3.eth.contract(abi.airdrop).at(Deployed.airdrop[network]);return airdropC}).then(function(airdropC){return airdropC.getFee({from:sender}).then(function(_fee){var data=airdropC.drop.getData(token,addresses,amount),tx={to:token,from:sender,value:web3.toHex(_fee),data:data,nonce:nonce,gasPrice:web3.toHex(gasPrice)};return web3.eth.estimageGas(tx).then(function(_gas){var ethGas=gasPrice*_gas;return web3.eth.getBalance(sender).then(function(_bal){return _bal.lt(ethGas)?_promise2["default"].reject(errors.BALANCE_NOT_ENOUGH):new Tx(tx)})})}).then(function(_tx){_tx.sign(secret);var s="0x"+_tx.serialize().toString("hex");return web3.eth.sendRawTransaction(s)}).then(function(_txhash){return{state:STATE.DOING,error:null}})["catch"](function(err){return errors.hasOwnProperty(err)?{state:STATE.ERROR,error:err}:{state:STATE.ERROR,error:errors.RPC_ERROR}})}));case 17:case"end":return _context2.stop()}},_callee2,this)}));return function(_x3,_x4){return _ref2.apply(this,arguments)}}(),errors=require("./errors"),Tx=require("ethereumjs-tx"),Deployed=require("./deployed"),erc20=require("./erc20"),abi=require("./abi"),_types=require("./tx").TYPES,_state=["NONE","READY","WAIT_FOR_SCHEDULE","WAIT_FOR_FUND","DOING","DONE","PAUSE","ERROR","CANCELED"],STATE={};_state.forEach(function(e,i){STATE[e]=i}),exports.TYPES=_types,exports.STATE=STATE,exports.runTask=runTask;